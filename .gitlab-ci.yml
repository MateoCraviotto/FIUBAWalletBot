image: ruby:3.1.2

services:
  - docker:dind

variables:
  REGISTRY_URL: registry.gitlab.com/fiuba-memo2/tp2
  KUBE_NAMESPACE_PREFIX: tokio
  APP_NAME: $CI_PROJECT_NAME
  GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task

stages:
  - build
  - package
  - deploy_test
  - deploy_prod

build_job:
  stage: build
  script:
    - gem install bundler -v 2.3.26 --no-document
    - bundle install --without staging production
    - ENV=test bundle exec rake build_server
    - bundle exec rake version > VERSION.txt
  artifacts:
    paths:
      - VERSION.txt
      - reports/
    reports:
      junit: reports/spec/rspec.xml


package_job:
  stage: package
  image: docker:stable
  before_script:
    - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  script:
    - VERSION=$(cat VERSION.txt)
    - echo $VERSION
    - docker build -f Dockerfile.prod --build-arg VERSION=$VERSION --build-arg GIT_COMMIT=$CI_COMMIT_SHORT_SHA -t $REGISTRY_URL/${APP_NAME}:$VERSION .
    - docker tag $REGISTRY_URL/${CI_ENVIRONMENT_NAME}:$VERSION $REGISTRY_URL/${APP_NAME}:latest
    - docker push $REGISTRY_URL/${APP_NAME}:$VERSION
    - docker push $REGISTRY_URL/${APP_NAME}:latest
  only:
    - tags

deploy_test_job:
  stage: deploy_test
  image: nicopaez/kubectl:1.22.0
  environment: test
  script:
    - VERSION=$(cat VERSION.txt)
    - cp ${KUBECONFIG_DO} $HOME/.kube/config
    - kubectl -n ${KUBE_NAMESPACE_PREFIX}-${CI_ENVIRONMENT_NAME} apply -f k8s/test.configmap.yaml
    - kubectl -n ${KUBE_NAMESPACE_PREFIX}-${CI_ENVIRONMENT_NAME} set image deployment/telegrambot telegrambot=$REGISTRY_URL/${APP_NAME}:$VERSION
  only:
    - tags

deploy_prod_job:
  stage: deploy_prod
  image: nicopaez/kubectl:1.22.0
  environment: prod
  script:
    - VERSION=$(cat VERSION.txt)
    - cp ${KUBECONFIG_DO} $HOME/.kube/config
    - kubectl -n ${KUBE_NAMESPACE_PREFIX}-${CI_ENVIRONMENT_NAME} apply -f k8s/prod.configmap.yaml
    - kubectl -n ${KUBE_NAMESPACE_PREFIX}-${CI_ENVIRONMENT_NAME} set image deployment/telegrambot telegrambot=$REGISTRY_URL/${APP_NAME}:$VERSION
  only:
    - tags
  when: manual
